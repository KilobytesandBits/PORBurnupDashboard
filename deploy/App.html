<!DOCTYPE html>
<html>
<head>
    <title>PORBurnupDashboard</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var types=Ext.data.Types;Ext.define("MilestoneTreeModel",{extend:"Ext.data.TreeModel",fields:[{name:"ObjectID",mapping:"ObjectID",type:types.STRING},{name:"FormattedID",mapping:"FormattedID",type:types.STRING},{name:"Name",mapping:"Name",type:types.STRING},{name:"StartDate",mapping:"ActualStartDate",type:types.DATE},{name:"ActiveStartDate",mapping:"ActiveStartDate",type:types.DATE},{name:"TargetDate",mapping:"AcceptedDate",type:types.DATE},{name:"TargetProject",mapping:"TargetProject",type:types.OBJECT},{name:"ValueStream",mapping:"ValueStream",type:types.STRING},{name:"Visibility",mapping:"Visibility",type:types.STRING},{name:"AdditionalReferences",mapping:"AdditionalReferences",type:types.STRING},{name:"Status",mapping:"Status",type:types.STRING},{name:"DisplayColor",mapping:"DisplayColor",type:types.STRING},{name:"Notes",mapping:"Notes",type:types.STRING},{name:"_ref",mapping:"_ref",type:types.STRING},{name:"AcceptedLeafStoryCount",mapping:"AcceptedLeafStoryCount",type:types.STRING},{name:"LeafStoryCount",mapping:"LeafStoryCount",type:types.STRING},{name:"FeaturesWithoutChildrenCount",mapping:"FeaturesWithoutChildrenCount",type:types.INT},{name:"StoryProgressPercent",mapping:"StoryProgressPercent",type:types.FLOAT}],hasMany:{model:"FeatureTreeModel",name:"features",associationKey:"features"}}),Ext.define("MilestoneDataModel",{extend:"Ext.data.Model",fields:[{name:"ObjectID",mapping:"ObjectID",type:types.STRING},{name:"FormattedID",mapping:"FormattedID",type:types.STRING},{name:"Name",mapping:"Name",type:types.STRING},{name:"ActiveStartDate",mapping:"ActiveStartDate",type:types.DATE},{name:"StartDate",mapping:"ActualStartDate",type:types.DATE},{name:"TargetDate",mapping:"AcceptedDate",type:types.DATE},{name:"TargetProject",mapping:"TargetProject",type:types.OBJECT},{name:"ValueStream",mapping:"ValueStream",type:types.STRING},{name:"Visibility",mapping:"Visibility",type:types.STRING},{name:"AdditionalReferences",mapping:"AdditionalReferences",type:types.STRING},{name:"Status",mapping:"Status",type:types.STRING},{name:"DisplayColor",mapping:"DisplayColor",type:types.STRING},{name:"Notes",mapping:"Notes",type:types.STRING},{name:"_ref",mapping:"_ref",type:types.STRING},{name:"AcceptedLeafStoryCount",mapping:"AcceptedLeafStoryCount",type:types.INT},{name:"LeafStoryCount",mapping:"LeafStoryCount",type:types.INT},{name:"FeaturesWithoutChildrenCount",mapping:"FeaturesWithoutChildrenCount",type:types.INT},{name:"StoryProgressPercent",mapping:"StoryProgressPercent",type:types.FLOAT}]}),Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",config:{defaultSettings:{valueStreamPicker:"FPA, Integration"}},getSettingsFields:function(){return[{name:"includeGlobalMilestones",xtype:"rallycheckboxfield",fieldLabel:"",boxLabel:"Include global milestones"},{name:"showNumberOfMonths",xtype:"rallynumberfield",fieldLabel:"Date Range (months)"},{name:"valueStreamPicker",xtype:"rallyfieldvaluecombobox",model:"Milestone",field:"c_ValueStream",fieldLabel:"Value Stream",allowNoEntry:!0,multiSelect:!0},{name:"teamPicker",xtype:"rallymultiobjectpicker",modelType:"Project",fieldLabel:"Associated Teams"}]},items:[{xtype:"container",itemId:"filterContainer",id:"filterContainer",layout:{type:"hbox",align:"left"}},{xtype:"container",itemId:"gridContainer",id:"gridContainer"}],launch:function(){this.down("#filterContainer").add({xtype:"rallycheckboxfield",id:"executiveVisibilityCheckbox",boxLabel:"Show Executive Visibility Only",labelWidth:200,padding:"10, 5, 10, 5",checked:!1,listeners:{change:this._onReady,render:this._onReady,scope:this}},{xtype:"panel",bodyPadding:5,width:400,layout:{type:"hbox",align:"left"},defaults:{labelWidth:80,xtype:"datefield",flex:1,style:{padding:"10px"}},items:[{xtype:"rallydatefield",fieldLabel:"Start Date",listeners:{change:this._onReady,render:this._onReady,scope:this}},{xtype:"rallydatefield",fieldLabel:"End Date",listeners:{change:this._onReady,render:this._onReady,scope:this}}]},{xtype:"rallymultiobjectpicker",padding:"10, 5, 10, 5",modelType:"Project",fieldLabel:"Teams",labelAlign:"right",width:400,listeners:{change:this._onReady,render:this._onReady,scope:this}})},_onReady:function(){this._getAllChildProjectsForCurrentProject(this.project)},_getAllChildProjectsForCurrentProject:function(currProject){Ext.getBody().mask("Loading..."),this.allProjectsList=[];var that=this,projectStore=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:["Name","State","Parent","Children"],autoLoad:!0,compact:!1,context:{workspace:that.getContext().getWorkspace()._Ref,projectScopeUp:!1,projectScopeDown:!0},limit:1/0,filters:[{property:"State",operator:"=",value:"Open"}],sorters:[{property:"Name",direction:"ASC"}],listeners:{load:function(projectStore,data,success){this.requiredProjectsList=[],this.allProjectsColl=data;var selectedProj=this.getContext().getProject(),selectedProjRef="/project/"+selectedProj.ObjectID;this.requiredProjectsList.push(selectedProj.ObjectID);var selectedProjChildren=selectedProj.Children;selectedProjChildren&&selectedProjChildren.Count>0&&this._loadAllChildProjectsFromParent(selectedProjRef),console.log("creating the milestone Store Filter..."),this._createMilestoneStoreFilter(),console.log("creating Milestone store."),this._createMilestoneStore()},scope:this}})},_loadAllChildProjectsFromParent:function(parentProjRef){var that=this;Ext.Array.each(this.allProjectsColl,function(thisProject){if(thisProject.get("Parent")&&null!==thisProject.get("Parent")._ref&&thisProject.get("Parent")._ref==parentProjRef){that.requiredProjectsList.push(thisProject.data.ObjectID);var projChildren=thisProject.get("Children");projChildren&&projChildren.Count>0&&that._loadAllChildProjectsFromParent(thisProject.get("_ref"))}})},_createMilestoneStoreFilter:function(){if(this.projectMilestoneFilter=Ext.create("Rally.data.wsapi.Filter",{property:"TargetDate",operator:">=",value:"today-15"}),this._getVisibilityFilter()&&(this.projectMilestoneFilter=this.projectMilestoneFilter.and(Ext.create("Rally.data.wsapi.Filter",{property:"c_ExecutiveVisibility",operator:"=",value:this._getVisibilityFilter()}))),this.getSetting("showNumberOfMonths")&&this.getSetting("showNumberOfMonths")>0){var endDate=Rally.util.DateTime.add(new Date,"month",this.getSetting("showNumberOfMonths"));this.projectMilestoneFilter=this.projectMilestoneFilter.and(Ext.create("Rally.data.wsapi.Filter",{property:"TargetDate",operator:"<=",value:endDate}))}var vsSelectedValues=this.getSetting("valueStreamPicker"),vsFilters=vsSelectedValues.split(",");if(console.log("valuesteam settings value: ",vsFilters),this.projectMilestoneFilter=this.projectMilestoneFilter.and(Ext.create("Rally.data.wsapi.Filter",{property:"c_ValueStream",operator:"contains",value:vsFilters[0]})),vsFilters.length>1)for(var i=1;vsFilters.length>i;i++)this.projectMilestoneFilter=this.projectMilestoneFilter.or(Ext.create("Rally.data.wsapi.Filter",{property:"c_ValueStream",operator:"contains",value:vsFilters[i]}));console.log("valuesteam settings filter: ",this.projectMilestoneFilter)},_createMilestoneStore:function(){Ext.create("Rally.data.wsapi.Store",{model:"milestone",autoLoad:!0,compact:!1,listeners:{load:function(store,data,success){this._filterMileStones(data)},scope:this},filters:this.projectMilestoneFilter,sorters:[{property:"c_ValueStream",direction:"ASC"},{property:"TargetDate",direction:"ASC"}]})},_filterMileStones:function(milestones){var that=this,filteredMilestonesArr=[];Ext.each(milestones,function(milestone,index){null!==milestone.data.TargetProject&&""!==milestone.data.TargetProject&&that.requiredProjectsList.indexOf(milestone.data.TargetProject.ObjectID)>-1&&filteredMilestonesArr.push(milestone),that.getSetting("includeGlobalMilestones")&&null===milestone.data.TargetProject&&filteredMilestonesArr.push(milestone)}),this._loadArtifactsForMilestones(filteredMilestonesArr)},_loadArtifactsForMilestones:function(milestoneArr){var that=this;this.milestoneProjectColl=[],this._loadArtifacts(milestoneArr).then({success:function(records){that.milestoneDataArray=[],Ext.Array.each(records,function(record,index){console.log("milestone Artifact coll of : "+index+" is : ",record);var storyCountInfo=that._computeArtifactsAssociation(record),milestoneRec=milestoneArr[index],milestoneCustomData=that._createCustomMilestoneData(milestoneRec,storyCountInfo);that.milestoneDataArray.push(milestoneCustomData),that.allAssociatedProjectColl=[],null!==record&&record.length>0&&that._loadAllHierarchicalProjects(record).then({success:function(records){var me=that;Ext.Array.each(records,function(userStoryColl){var you=me;Ext.Array.each(userStoryColl,function(userStory){if(userStory&&userStory.get("Project")){var proj=userStory.get("Project");you._isProjectPresentInAllAssociatedArtifactProjecColl(proj)===!1&&you.allAssociatedProjectColl.push(proj)}})}),me.milestoneProjectColl.push({key:milestoneRec,value:me.allAssociatedProjectColl})},scope:that}).then({success:function(){console.log("Milestone Projects association list: ",that.milestoneProjectColl)},failure:function(error){console.log("There are some errors while loading artifact projects."),Ext.getBody().unmask()},scope:that})}),that._organiseMilestoneBasedOnValuestream(that.milestoneDataArray)},failure:function(error){console.log("There are some errors loading artifacts."),Ext.getBody().unmask()},scope:that})},_isProjectPresentInAllAssociatedArtifactProjecColl:function(proj){var isPresent=!1;return Ext.Array.each(this.allAssociatedProjectColl,function(projRec){return projRec&&proj&&projRec.Name===proj.Name?(isPresent=!0,void 0):void 0}),isPresent},_createCustomMilestoneData:function(milestoneItem,storyCountInfo){var milestoneData=Ext.create("MilestoneDataModel",{ObjectID:milestoneItem.get("ObjectID"),FormattedID:milestoneItem.get("FormattedID"),Name:milestoneItem.get("Name"),StartDate:storyCountInfo.startDate,ActiveStartDate:milestoneItem.get("c_ActiveStartDate"),TargetDate:milestoneItem.get("TargetDate"),TargetProject:milestoneItem.get("Name"),ValueStream:milestoneItem.get("c_ValueStream"),AdditionalReferences:milestoneItem.get("c_AdditionalReferences"),Visibility:milestoneItem.get("c_ExecutiveVisibility"),Status:milestoneItem.get("c_Test"),DisplayColor:milestoneItem.get("DisplayColor"),Notes:milestoneItem.get("Notes"),_ref:milestoneItem.get("_ref"),AcceptedLeafStoryCount:storyCountInfo.acceptedCount,LeafStoryCount:storyCountInfo.storyCount,FeaturesWithoutChildrenCount:storyCountInfo.featureNotBrokenCount,StoryProgressPercent:storyCountInfo.storyCount>0?storyCountInfo.acceptedCount/storyCountInfo.storyCount:0});return milestoneData},_loadArtifacts:function(milestoneList){var promises=[],that=this;return Ext.Array.each(milestoneList,function(milestone){var artifactStore=Ext.create("Rally.data.wsapi.artifact.Store",{models:["portfolioitem/feature","defect","userstory"],context:{workspace:that.getContext().getWorkspace()._Ref,project:null,limit:1/0,projectScopeUp:!1,projectScopeDown:!0},filters:[{property:"Milestones.ObjectID",operator:"=",value:milestone.get("ObjectID")}]});promises.push(that._loadArtifactStore(artifactStore))}),Deft.Promise.all(promises)},_loadArtifactStore:function(store){var deferred;return deferred=Ext.create("Deft.Deferred"),store.load({callback:function(records,operation,success){success?deferred.resolve(records):deferred.reject("Error loading Artifacts.")}}),deferred.promise},_loadAllHierarchicalProjects:function(artifactColl){var promises=[],that=this;return Ext.Array.each(artifactColl,function(artifact){var itemType=artifact.get("_type");if("hierarchicalrequirement"==itemType||"defect"==itemType){var project=artifact.get("Project");project&&_.contains(that.allAssociatedProjectColl,project)&&that.allAssociatedProjectColl.push(project)}else{var hierarchicalrequirementStore=Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",fetch:["ObjectID","FormattedID","Name","Project","Feature"],context:{workspace:that.getContext().getWorkspace()._Ref,project:null,limit:1/0,projectScopeUp:!1,projectScopeDown:!0},filters:[{property:"Feature.ObjectID",operator:"=",value:artifact.get("ObjectID")}]});promises.push(that._loadAllHierarchicalProjectsStore(hierarchicalrequirementStore))}}),Deft.Promise.all(promises)},_loadAllHierarchicalProjectsStore:function(store){var deferred;return deferred=Ext.create("Deft.Deferred"),store.load({callback:function(records,operation,success){success?deferred.resolve(records):deferred.reject("Error loading Hierarchical Projects.")}}),deferred.promise},_computeArtifactsAssociation:function(artifactColl){var that=this,storyCountInfo={storyCount:0,acceptedCount:0,startDate:null,featureNotBrokenCount:0},leafStoryCount=0,acceptedLeafStoryCount=0,startDate=null,featuresWithoutChildren=0;return artifactColl.length>0&&Ext.Array.each(artifactColl,function(item){var itemType=item.get("_type"),scheduleState=item.get("ScheduleState");if("hierarchicalrequirement"==itemType||"defect"==itemType){leafStoryCount+=1,"Accepted"==scheduleState&&(acceptedLeafStoryCount+=1);var inProgressDate=item.get("InProgressDate");(null===startDate||startDate>inProgressDate)&&(startDate=inProgressDate)}else{0===item.get("LeafStoryCount")?featuresWithoutChildren+=1:(leafStoryCount+=item.get("LeafStoryCount"),acceptedLeafStoryCount+=item.get("AcceptedLeafStoryCount"));var portfolioStartDate=item.get("ActualStartDate");(null===startDate||startDate>portfolioStartDate)&&(startDate=portfolioStartDate)}}),storyCountInfo.storyCount=leafStoryCount,storyCountInfo.acceptedCount=acceptedLeafStoryCount,storyCountInfo.featureNotBrokenCount=featuresWithoutChildren,null!==startDate&&(storyCountInfo.startDate=startDate),storyCountInfo},_organiseMilestoneBasedOnValuestream:function(filteredMilestonesArr){this.valueStreamMilestoneColl=[],this.valueStreamColl=[];var nonVSCount=0,that=this;Ext.Array.each(filteredMilestonesArr,function(thisData){var valuestream=thisData.get("ValueStream");null!==valuestream&&""!==valuestream?0===that.valueStreamColl.length?that.valueStreamColl.push(valuestream):that.valueStreamColl.length>0&&-1===that.valueStreamColl.indexOf(valuestream)&&that.valueStreamColl.push(valuestream):nonVSCount++}),this.valueStreamColl.sort(),nonVSCount>0&&this.valueStreamColl.push("N/A"),Ext.Array.each(this.valueStreamColl,function(valuestream){var milestoneColl=that._getAllAssociatedMilestones(valuestream,filteredMilestonesArr);that.valueStreamMilestoneColl.push({key:valuestream,value:milestoneColl})}),this._createValueStreamMilestonesTreeNode()},_createValueStreamMilestonesTreeNode:function(){var valueStreamRootNode=Ext.create("MilestoneTreeModel",{Name:"ValueStream Root",text:"ValueStream Root",root:!0,expandable:!0,expanded:!0});this._createValueStreamNodesAlongWithAssociatedChildMilestoneNodes(valueStreamRootNode),this._createValueStreamMilestoneGrid(valueStreamRootNode)},_createValueStreamMilestoneGrid:function(valueStreamRootNode){console.log("createValueStreamMilestoneGrid calling.....");var milestonesTreePanel=Ext.getCmp("milestonesTreePanel");milestonesTreePanel&&milestonesTreePanel.destroy();var me=this,milestoneValueStreamTreeStore=Ext.create("Ext.data.TreeStore",{model:"MilestoneTreeModel",root:valueStreamRootNode});this.chartDiag=Ext.create("Rally.ui.dialog.Dialog",{autoShow:!1,draggable:!1,closable:!0,closeAction:"hide",padding:10,width:800,height:500,autoScroll:!0,id:"Burnup_Chart_Diag"}),this.chartDiag.hide();var valuestreamMilestoneTreePanel=Ext.create("Ext.tree.Panel",{id:"milestonesTreePanel",itemId:"milestonesTreePanel",store:milestoneValueStreamTreeStore,useArrows:!0,rowLines:!0,displayField:"Name",rootVisible:!1,width:this.getWidth(!0),height:this.getHeight(!0),viewConfig:{getRowClass:function(record,index){var nameRecord=Ext.String.format("{0}",record.get("Name"));return nameRecord&&-1===nameRecord.search("valuestream:")?"row-child":"row-parent"}},columns:[{xtype:"treecolumn",text:"Name",dataIndex:"Name",resizeable:!0,flex:3,minWidth:200,renderer:function(value,style,item,rowIndex){var link=Ext.String.format("{0}",value);if(-1===link.search("valuestream:")){var ref=item.get("_ref");link=Ext.String.format("<a target='_top' href='{1}'><b>{0}</b></a>",value,Rally.nav.Manager.getDetailUrl(ref))}else{var onlyName=link.replace("valuestream:","");link=Ext.String.format("<b>{0}</b>",onlyName)}return link}},{text:"Project",dataIndex:"TargetProject",flex:2,hidden:!0},{text:"Start Date",dataIndex:"StartDate",flex:1,renderer:function(value){return value?Rally.util.DateTime.format(value,"m/d/Y"):void 0},hidden:!0},{text:"Target Date",dataIndex:"TargetDate",flex:1,renderer:function(value){if(value){var formattedDate=Rally.util.DateTime.format(value,"M Y"),formattedField;return formattedField=new Date>value?Ext.String.format("<div style='color:grey'>{0}</div>",formattedDate):Ext.String.format("<div>{0}</div>",formattedDate)}}},{xtype:"templatecolumn",text:"Progress",dataIndex:"StoryProgressPercent",tooltip:"click to view details.",tpl:Ext.create("Rally.ui.renderer.template.progressbar.ProgressBarTemplate",{percentDoneName:"StoryProgressPercent",showOnlyIfInProgress:!0,showDangerNotificationFn:function(value){return value.FeaturesWithoutChildrenCount>0?!0:!1},calculateColorFn:function(value){var targetDate=value.TargetDate,per=0,colorHex="#77D38D";return value.StoryProgressPercent&&targetDate&&(per=parseFloat(value.StoryProgressPercent),colorHex=me._getPercentDoneColor(targetDate,value.StartDate,value.StoryProgressPercent)),colorHex}}),flex:1},{text:"Accepted Count",dataIndex:"AcceptedLeafStoryCount",flex:1},{text:"Story Count",dataIndex:"LeafStoryCount",flex:1},{text:"Status",dataIndex:"DisplayColor",flex:1,hidden:!0,renderer:function(value){if(value){var colorHtml=Ext.String.format("<div class= 'color-box' style= 'background-color: {0};'></div>",value);return colorHtml}}},{text:"Notes",dataIndex:"Notes",flex:4},{xtype:"actioncolumn",text:"References",width:50,items:[{icon:"https://cdn3.iconfinder.com/data/icons/fatcow/16x16_0620/page_link.png",tooltip:"References",width:75,tooltip:"View",handler:function(grid,rowIndex,colIndex){var record=grid.getStore().getAt(rowIndex);if(null!=record.get("FormattedID")&&""!=record.get("FormattedID")){var dialogTitle=record.get("FormattedID")+": Additional References";if(null!==record.get("AdditionalReferences")&&""!==record.get("AdditionalReferences"))var chartDiag=Ext.create("Rally.ui.dialog.Dialog",{autoShow:!0,draggable:!1,closable:!0,closeAction:"destroy",padding:10,width:800,title:dialogTitle});else Ext.Msg.alert(dialogTitle,"Sorry! There are NO reference mentioned.")}else Ext.Msg.alert("Reference","No Reference is available for valuestream item. Please click on individual milstone reference icon to get the references.")}}]},{xtype:"actioncolumn",text:"Chart",width:50,items:[{icon:"https://cdn4.iconfinder.com/data/icons/6x16-free-application-icons/16/3d_bar_chart.png",tooltip:"Burnup Chart",width:75,tooltip:"View",handler:function(grid,rowIndex,colIndex){var record=grid.getStore().getAt(rowIndex);if(null!=record.get("FormattedID")&&""!=record.get("FormattedID")){var dialogTitle=record.get("FormattedID")+": Burnup Chart";me.chartDiag.setTitle(dialogTitle),me.chartDiag.removeAll(!0),me.chartDiag.show(),me._getMilestoneBurnupChart(record,me.chartDiag)}else Ext.Msg.alert("Burnup Chart","No Chart is available for valuestream item. Please click on individual milstone chart icon to get the chart.")}}]}]});valuestreamMilestoneTreePanel.on({cellclick:{fn:this._onTreePanelItemClick,scope:this}});var gridContainer=this.getComponent("gridContainer");null!==gridContainer&&(gridContainer.removeAll(),gridContainer.add(valuestreamMilestoneTreePanel)),Ext.getBody().unmask()},_getColumnIndex:function(grid,headerName){for(var gridColumns=grid.headerCt.getGridColumns(),i=0;gridColumns.length>i;i++)if(gridColumns[i].text==headerName)return i},_getFieldText:function(fieldValue,defaultValue){return _.isUndefined(fieldValue)||_.isNull(fieldValue)?defaultValue:fieldValue},_displayNotesDailog:function(recordData){Ext.create("Rally.ui.dialog.RichTextDialog",{autoShow:!0,title:"Milestone Note(s)",record:recordData,fieldName:"Notes",height:350,width:550,closable:!0})},_onTreePanelItemClick:function(view,td,cellIndex,record,tr,rowIndex){if(4===cellIndex){console.log("In side the Progress bar cell"),console.log("On Cell Click: Data Model is : ",record);var tooltipTitle="<h3>"+record.data.FormattedID+" : "+record.data.Name+"</h3>",htmlString=this._getTootipPopupContent(record),tooltip=Ext.create("Rally.ui.tooltip.ToolTip",{target:td,anchor:"left",items:[{xtype:"label",forId:"myFieldId",html:tooltipTitle,margin:"10 10 10 10"},{xtype:"form",bodyPadding:10,layout:"fit",items:[{xtype:"displayfield",fieldLabel:"Details",hideLabel:!0,name:"progress_details",value:htmlString,autoScroll:!0}]}],layout:{type:"vbox",align:"left"}});console.log("Tool Tip: ",tooltip)}},_getTootipPopupContent:function(record){var progressPercentage=100*record.data.StoryProgressPercent.toFixed(2),htmlstring="<h3>Progress:</h3>";htmlstring+="<p>Total Story Count: <span><strong>"+record.data.LeafStoryCount+"</strong></span></p>",htmlstring+="<p>Total Accepted Story Count: <span><strong>"+record.data.AcceptedLeafStoryCount+"</strong></span></p>",htmlstring+="<p>Percentage of Progress: <span><strong>"+progressPercentage+" %</strong></span></p>",htmlstring+="<hr>",record.data.FeaturesWithoutChildrenCount>0&&(htmlstring+='<h3 style="color:red;">Alerts:</h3>',htmlstring+='<p style="color:red; font-weight: bold;">There are <span><u>'+record.data.FeaturesWithoutChildrenCount+" Features</u></span> still not broken down into user stories.</p>",htmlstring+="<hr>");var targetDate=null!==record.data.TargetDate?Rally.util.DateTime.format(record.data.TargetDate,"m/d/Y"):"Not Mentioned",actualStartDate=null!==record.data.StartDate?Rally.util.DateTime.format(record.data.StartDate,"m/d/Y"):"Not Started";return htmlstring+="<h3>Info:</h3>",htmlstring+="<p>Milestone Target Date: <span><strong>"+targetDate+"</strong></p>",htmlstring+="<p>Milestone Actual Start Date: <span><strong>"+actualStartDate+"</strong></p>",htmlstring+="<hr>",htmlstring+="<h3>Notes: <h3>",htmlstring+='<p style="width: 100px; white-space: pre-line;">'+record.data.Notes+"</p>"},_onTreePanelItemMouseEnter:function(view,record,item,index){console.log("On Mouse Enter: record is : ",record),console.log("On Mouse Enter: column is : ",item),console.log("On Mouse Enter: index is : ",index)},_getPercentDoneColor:function(milestoneEndDate,milestoneStartDate,milestonePercentDone){var greenHex="#1B801D",yellowHex="#FFFF00",redHex="#FE2E2E",blueHex="#1874CD",whiteHex="#FFFFFF",startDate=null,endDate=null,asOfDate=new Date,percentComplete=100*milestonePercentDone;startDate=null!==milestoneStartDate?milestoneStartDate:asOfDate,endDate=null!==milestoneEndDate?milestoneEndDate:asOfDate;var dateDifference=Rally.util.DateTime.getDifference(endDate,startDate,"day"),startDateNumber=1,endDateNumber=startDateNumber+dateDifference,asOfDateNumber=Rally.util.DateTime.getDifference(asOfDate,startDate,"day")+1,acceptanceStartDelay=.2*(endDateNumber-startDateNumber),warningDelay=.2*(endDateNumber-startDateNumber),inProgress=percentComplete>0;if(startDate>asOfDate)return whiteHex;if(asOfDate>=endDate)return percentComplete>=100?blueHex:redHex;var redXIntercept=startDateNumber+acceptanceStartDelay+warningDelay,redSlope=100/(endDateNumber-redXIntercept),redYIntercept=-1*redXIntercept*redSlope,redThreshold=redSlope*asOfDateNumber+redYIntercept;if(redThreshold>percentComplete)return redHex;var yellowXIntercept=startDateNumber+acceptanceStartDelay,yellowSlope=100/(endDateNumber-yellowXIntercept),yellowYIntercept=-1*yellowXIntercept*yellowSlope,yellowThreshold=yellowSlope*asOfDateNumber+yellowYIntercept;return yellowThreshold>percentComplete?yellowHex:greenHex},_createValueStreamNodesAlongWithAssociatedChildMilestoneNodes:function(valustreamRootNode){var that=this;Ext.Array.each(this.valueStreamMilestoneColl,function(thisData){var valueStreamNode=that._createValueStreamNode(thisData.key);Ext.Array.each(thisData.value,function(thisMilestoneData){var milestoneNode=that._createMilestoneNode(thisMilestoneData);valueStreamNode.appendChild(milestoneNode)}),valustreamRootNode.appendChild(valueStreamNode)})},_createValueStreamNode:function(valuestreamData){var valueStreamLable="valuestream: "+valuestreamData,valustreamTreeNode=Ext.create("MilestoneTreeModel",{Name:valueStreamLable,AcceptedLeafStoryCount:"",LeafStoryCount:"",StoryProgressPercent:"",leaf:!1,expandable:!0,expanded:!0,iconCls:"no-icon"});return valustreamTreeNode},_createMilestoneNode:function(milestoneData){var targetProjectName=null!==milestoneData.get("TargetProject")?milestoneData.get("TargetProject")._refObjectName:"Global",milestoneTreeNode=Ext.create("MilestoneTreeModel",{ObjectID:milestoneData.get("ObjectID"),FormattedID:milestoneData.get("FormattedID"),Name:milestoneData.get("Name"),StartDate:milestoneData.get("StartDate"),ActiveStartDate:milestoneData.get("ActiveStartDate"),TargetDate:milestoneData.get("TargetDate"),TargetProject:targetProjectName,DisplayColor:milestoneData.get("DisplayColor"),Notes:milestoneData.get("Notes"),AdditionalReferences:milestoneData.get("AdditionalReferences"),_ref:milestoneData.get("_ref"),AcceptedLeafStoryCount:""+milestoneData.get("AcceptedLeafStoryCount"),LeafStoryCount:""+milestoneData.get("LeafStoryCount"),StoryProgressPercent:""+milestoneData.get("StoryProgressPercent"),FeaturesWithoutChildrenCount:""+milestoneData.get("FeaturesWithoutChildrenCount"),leaf:!0,expandable:!1,expanded:!1,iconCls:"no-icon"});return milestoneTreeNode},_getAllAssociatedMilestones:function(valuestream,milestoneStoreData){var milestoneColl=[];return Ext.Array.each(milestoneStoreData,function(milestone){var vsRecord=milestone.get("ValueStream");vsRecord=null!==vsRecord&&""!==vsRecord?vsRecord:"N/A",vsRecord===valuestream&&milestoneColl.push(milestone)}),milestoneColl},_getVisibilityFilter:function(){var visibilityCheckBox=Ext.getCmp("executiveVisibilityCheckbox");return visibilityCheckBox.getValue()},_getMilestoneBurnupChart:function(milestoneRec,chartDiag){var chartDiagId=chartDiag.getId();null!==milestoneRec&&(console.log("milestoneData: ",milestoneRec),this.selectedMilestone=milestoneRec.get("ObjectID"),this.selectedMilestoneObj=milestoneRec,Ext.getCmp(chartDiagId).mask("Creating Burnup Chart for "+this.selectedMilestoneObj.get("FormattedID")+"..."),this._getBurnupChart(chartDiag))},_getBurnupChart:function(chartDiag){Deft.Promise.all([this._loadPIsInMilestone(),this._loadScheduleStateValues()]).then({success:function(){var burnupChart=this._getChart(!0,null,chartDiag);if(null!==burnupChart){chartDiag.removeAll(!0),chartDiag.add(burnupChart);var that=this;Ext.Array.each(this.piRecords,function(piRecord,index){var piBurnupChart=that._getChart(!1,piRecord,chartDiag);null!==piBurnupChart&&chartDiag.add(piBurnupChart)})}},scope:this})},_loadScheduleStateValues:function(){return Rally.data.ModelFactory.getModel({type:"UserStory",success:function(model){model.getField("ScheduleState").getAllowedValueStore().load({callback:function(records){this.scheduleStateValues=_.invoke(records,"get","StringValue")},scope:this})},scope:this})},_loadPIsInMilestone:function(){var that=this;return Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",autoLoad:!0,fetch:["TypePath"],filters:[{property:"Parent.Name",value:"Portfolio Item"},{property:"Ordinal",value:0}]}).load().then({success:function(records){return this.piType=records[0].get("TypePath"),Ext.create("Rally.data.wsapi.Store",{model:this.piType,fetch:["ObjectID","FormattedID","Project","Name","PreliminaryEstimate","ActualStartDate","PlannedEndDate","AcceptedLeafStoryPlanEstimateTotal","LeafStoryPlanEstimateTotal"],filters:[{property:"Milestones.ObjectID",operator:"=",value:this.selectedMilestone}],context:{project:null},limit:1/0}).load().then({success:function(piRecords){this.piRecords=piRecords},scope:this})},scope:this})},_getChart:function(isMileStone,piRecord,chartDiag){var that=this,chartStartDate=""!==that.selectedMilestoneObj.get("ActiveStartDate")?that.selectedMilestoneObj.get("ActiveStartDate"):_.min(_.compact(_.invoke(that.piRecords,"get","ActualStartDate"))),chartEndDate=that.selectedMilestoneObj.get("TargetDate"),chart={xtype:"rallychart",flex:1,storeType:"Rally.data.lookback.SnapshotStore",storeConfig:isMileStone?that._getStoreConfig():that._getStoreConfigForPI(piRecord.data.ObjectID),calculatorType:"Rally.example.BurnCalculator",calculatorConfig:{completedScheduleStateNames:["Accepted","Released"],stateFieldValues:that.scheduleStateValues,startDate:chartStartDate,endDate:chartEndDate,enableProjects:!0},chartColors:["#A16E3A","#1B7F25","#B1B1B7","#2E2EAC"],chartConfig:that._getChartConfig(isMileStone,piRecord),listeners:{afterrender:function(obj,eOpts){Ext.getCmp(chartDiag.getId()).unmask()},scope:this}};return chart},_getStoreConfig:function(){return{find:{_TypeHierarchy:{$in:["HierarchicalRequirement"]},_ItemHierarchy:{$in:_.invoke(this.piRecords,"getId")}},fetch:["ScheduleState","PlanEstimate"],hydrate:["ScheduleState"],sort:{_ValidFrom:1},context:this.getContext().getDataContext(),limit:1/0}},_getStoreConfigForPI:function(piId){return{find:{_TypeHierarchy:{$in:["HierarchicalRequirement"]},_ItemHierarchy:piId},fetch:["ScheduleState","PlanEstimate"],hydrate:["ScheduleState"],sort:{_ValidFrom:1},context:this.getContext().getDataContext(),limit:1/0}},_getChartConfig:function(isMileStone,piRecord){return{chart:{defaultSeriesType:"area",zoomType:"xy"},title:{text:isMileStone?"Milestone Burnup":piRecord.data.FormattedID+" - "+piRecord.data.Name},xAxis:{categories:[],tickmarkPlacement:"on",tickInterval:5,title:{text:"Date",margin:10}},yAxis:[{title:{text:"Counts"}}],tooltip:{formatter:function(){return""+this.x+"<br />"+this.series.name+": "+Math.ceil(this.y)}},plotOptions:{series:{marker:{enabled:!1,states:{hover:{enabled:!0}}},groupPadding:.01},column:{stacking:null,shadow:!1}}}}});
                Ext.define("Rally.example.BurnCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",config:{completedScheduleStateNames:["Accepted"]},constructor:function(config){this.initConfig(config),this.callParent(arguments)},getDerivedFieldsOnInput:function(){var completedScheduleStateNames=this.getCompletedScheduleStateNames();return[{as:"StoryCount",f:function(snapshot){return 1}},{as:"CompletedStoryCount",f:function(snapshot){var ss=snapshot.ScheduleState;return completedScheduleStateNames.indexOf(ss)>-1?1:0}}]},getDerivedFieldsAfterSummary:function(){var stateFieldValues=this.stateFieldValues;return[{as:"Ideal",f:function(row,index,summaryMetrics,seriesData){var data=_.last(seriesData),max=seriesData[seriesData.length-1].Planned,increments=seriesData.length-1,incrementAmount;return 0===increments?max:(incrementAmount=max/increments,Math.floor(100*index*incrementAmount)/100)},display:"line"},{as:"Actual",f:function(row,index,summaryMetrics,seriesData){var today=Rally.util.DateTime.toIsoString(new Date),endIndex=_.findIndex(seriesData,function(data){return data.tick>today});if(0>endIndex&&(endIndex=seriesData.length-1),endIndex>=index){var acceptedSeriesData=_.pluck(seriesData,"Completed"),slope=(acceptedSeriesData[0]-acceptedSeriesData[endIndex])/(0-endIndex);return index*slope}},display:"line"}]},getMetrics:function(){return[{field:"StoryCount",as:"Planned",display:"line",f:"sum"},{field:"CompletedStoryCount",as:"Completed",f:"sum",display:"column"}]}});

            Rally.launchApp('CustomApp', {
                name:"PORBurnupDashboard",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .ico-test-valustream{width:20px;height:20px;top:8px;background-image:url('https://cdn4.iconfinder.com/data/icons/stash/128/ruby-16.png') !important}.ico-test-milestone{width:20px;height:20px;top:8px;background-image:url('https://cdn1.iconfinder.com/data/icons/all_google_icons_symbols_by_carlosjj-du/16/milestone.png') !important}.color-box{width:15px;height:15px;display:inline-block;background-color:#ccc;position:relative;left:10px;top:0px}.no-icon{display:none;background-image:url('ext/resources/images/default/s.gif') !important}.row-parent .x-grid-cell{background-color:#77D38D !important}.x-grid-item-over .row-parent .x-grid-cell{background-color:#3da5f5 !important}.x-grid-item-selected .row-parent .x-grid-cell{background-color:#ff0 !important}.row-child .x-grid-cell{background-color:#FFFFFF !important}.x-grid-item-over .row-child .x-grid-cell{background-color:#C2FABA !important}.x-grid-item-selected .row-child .x-grid-cell{background-color:#80AA79 !important}
    </style>
</head>
<body>
</body>
</html>
